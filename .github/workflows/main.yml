name: FIIs Report

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 9 * * 1'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: 'main'
          node-version: 16
        
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.1.0'

      - name: Install renv
        run: Rscript -e 'install.packages("renv")'
        
      - name: Initialize renv
        run: Rscript -e 'renv::init()'

      - name: Install libcurl package
        run: sudo apt-get install -y libcurl4-openssl-dev
      
      - name: Restore R packages cache
        uses: actions/cache@v2
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-renv-${{ hashFiles('renv.lock') }}
          restore-keys: ${{ runner.os }}-renv-

      - name: Install packages
        run: Rscript -e 'renv::restore()'

      - name: Run Rscript to Web Scrapping
        run: Rscript FIIs.R
        
      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.SENHA_DO_EMAIL }}
          subject: Relat√≥rio de Fundos Imobili√°rios (FIIS)
          body: |
            Prezado(a), tudo bem?

            Compartilho anexo relat√≥rio atualizado dos fundos imobili√°rios.
            
            Os principais tipos de FIIs s√£o:
            
            üèóÔ∏è <b>FIIs de tijolo:</b> Fundos que aplicam o seu patrim√¥nio na constru√ß√£o e/ou explora√ß√£o comercial de im√≥veis f√≠sicos, como galp√µes, pr√©dios de escrit√≥rios, shoppings, etc. 
            
            üìÉ <b>FIIs de papel:</b> aplicam o patrim√¥nio dos seus cotistas em instrumentos financeiros do setor imobili√°rio, tais como CRIs, LCIs e LHs.
            
            üèôÔ∏è <b>Fundos de Fundos (FoFs):</b> s√£o aqueles que aplicam o patrim√¥nio de seus cotistas exclusivamente em cotas de outros Fundos Imobili√°rios, viabilizando a diversifica√ß√£o com um √∫nico investimento.
            
            üöú <b>Fiagros:</b> o patrim√¥nio dos cotistas √© investido visando financiar as cadeias produtivas agroindustriais por meio de participa√ß√µes, propriedades rurais, terras ou im√≥veis agr√≠colas, al√©m de certificados de receb√≠veis.
            
            Breve explica√ß√£o das colunas do relat√≥rio:
            
            <b>papel:</b> O c√≥digo ou identificador do fundo imobili√°rio.<br>
            <b>segmento:</b> O segmento ou tipo de investimento em que o fundo imobili√°rio est√° enquadrado.<br>
            <b>cotacao:</b> O valor atual da cota do fundo imobili√°rio.<br>
            <b>ffo_yield:</b> O rendimento FFO (Funds From Operations) do fundo imobili√°rio em rela√ß√£o √† cota√ß√£o.<br>
            <b>dividend_yield:</b> O rendimento de dividendos do fundo imobili√°rio em rela√ß√£o √† cota√ß√£o.<br>
            <b>p_vp:</b> O pre√ßo-valor patrimonial (P/VP) do fundo imobili√°rio.<br>
            <b>valor_de_mercado:</b> O valor de mercado total do fundo imobili√°rio.<br>
            <b>liquidez:</b> A liquidez do fundo imobili√°rio, indicando a quantidade de negocia√ß√µes realizadas.<br>
            <b>qtd_de_imoveis:</b> A quantidade de im√≥veis que comp√µem o fundo imobili√°rio.<br>
            <b>preco_do_m2:</b> O pre√ßo m√©dio do metro quadrado dos im√≥veis do fundo.<br>
            <b>aluguel_por_m2:</b> O valor m√©dio de aluguel por metro quadrado dos im√≥veis do fundo.<br>
            <b>cap_rate:</b> A taxa de capitaliza√ß√£o do fundo imobili√°rio.<br>
            <b>vacancia_media:</b> A taxa m√©dia de vac√¢ncia dos im√≥veis do fundo.<br>
            <b>endereco:</b> O endere√ßo dos im√≥veis do fundo.<br>
            <b>data_atualizacao:</b> A data de atualiza√ß√£o dos dados na tabela.
            
            Aviso: Este estudo n√£o √© uma recomenda√ß√£o de compra ou venda, mas sim um estudo te√≥rico de data science. O mercado financeiro √© vol√°til e envolve riscos, por isso estude bem antes de realizar opera√ß√µes e converse com seu consultor.
            
            Desde j√° agrade√ßo pela aten√ß√£o e qualquer coisa permane√ßo √† disposi√ß√£o.
            
            Cordialmente,  
            Ramon Roldan.
          to: $${{ secrets.EMAIL }}
          Bcc: ${{ secrets.EMAIL_INTERASSADOS }}
          from: ${{ secrets.EMAIL }}
          content_type: text/plain
          attachments: |
            fiis.xlsx  

      - name: Commit Files
        run: |
          git config --local user.email "roldanramon83@gmail.com"
          git config --local user.name "Ramon Roldan de Lara"
          git add --all
          git commit -am "add data"
          git push 

